name: Terraform Plan
on:
  # Manual trigger of the workflow from the GitHub UI
  workflow_dispatch:

  # Any changes to pull requests targeting the specified branches will trigger the workflow
  # pull_request:
  #   branches:
  #     - dev
  #     - main
  #   types:
  #     - opened
  #     - synchronize
  #     - reopened
  #     - edited

permissions:
  contents: read
  id-token: write
  pull-requests: read

# Constants used across all jobs
env:
  AWS_REGION: eu-west-2
  AWS_ACCOUNT_ID: 667532145122
  ENVIRONMENT: |-
    ${{ case(
        github.ref_name == 'dev', 'dev',
        github.ref_name == 'main', 'stg',
        'dev'
    ) }}


jobs:
  Terraform-Plan-Job:
    runs-on:
      - codebuild-667532145122-github-runner-${{ github.run_id }}-${{ github.run_attempt }}
    # strategy:
    #   # Ensure the Terraform Plan jobs run sequentially based on the configuration layer
    #   max-parallel: 1
    #   matrix:
    #     configuration_layer: [
    #       "00_prerequisites",
    #       "10_data_storage",
    #       "20_networking",
    #       "30_virtual_desktop",
    #     ]

    steps:
      - run: echo "Environment         ${{ env.ENVIRONMENT }}"
      # - run: echo "Configuration Layer ${{ matrix.configuration_layer }}"

      - name: Checkout Repository
        uses: actions/checkout@v3

      # See: https://github.com/aws-actions/configure-aws-credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # See: https://github.com/hashicorp/setup-terraform
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          # FIXME - should get this from global vars...
          terraform_version: "~ 1.14.0"

      #Â Get the list of configuration layers from the repository and set it as an output variable
      - name: Get Configuration Layers
        id: get_config_layers
        run: |
          # Get the list of configuration layers (subdirectories in terraform/configuration_layers) and convert it to a JSON array          
          CONFIG_LAYERS=$(find terraform/configuration_layers -maxdepth 1 -type d -not -path "terraform/configuration_layers" -exec basename {} \;)

          SORTED_LAYERS=$(sort <<< "$CONFIG_LAYERS" | tr '\n' ' ' | sed 's/ $//')

          # Split the layers supplied as a list into array elements and create a JSON object to contain them.
          # 'echo -n' prevents the addition of a newline character at the end of the string, which can interfere with JSON parsing later on.
          # '--null-input' tells jq to not expect any input and allows us to create JSON from scratch.
          # '--slurp' allows us to read the entire input as a single string, which is necessary since we are passing a list of layers as a single string.
          # '--raw-input' treats the input as raw text, not JSON data
          # '--compact-output' produces a one-line output.
          CONFIG_LAYERS_JSON=$(echo -n "$SORTED_LAYERS" | jq --null-input --slurp --raw-input --compact-output '{ configuration_layers: [inputs] }')

          # Escape the JSON to ensure it can be safely passed as an output variable
          # --slurp mode - read all input into a single string (instead of processing line by line)
          ESCAPED_CONFIG_LAYERS_JSON=$(jq --slurp @json <<< "$CONFIG_LAYERS_JSON")

          echo "$ESCAPED_CONFIG_LAYERS_JSON"
          echo "CONFIG_LAYERS_JSON=$ESCAPED_CONFIG_LAYERS_JSON" >> $GITHUB_OUTPUT

      - name: Get Configuration Layers from JSON
        run: |
          echo "Received:"
          echo "${{ steps.get_config_layers.outputs.CONFIG_LAYERS_JSON }}"

          parsed_structure=${{ fromJSON( steps.get_config_layers.outputs.CONFIG_LAYERS_JSON ) }}
                    
          echo "Parsed structure:"
          echo "$parsed_structure"

          configuration_layers=$(echo "$parsed_structure" | jq -r '.configuration_layers[]')

          for config_layer in $configuration_layers; do
            echo "  - $config_layer"
          done

      # - name: Terraform Init
      #   env:
      #     BACKEND_FILE: terraform/environments/${{ env.ENVIRONMENT }}.tfbackend
      #   run: |          
      #     if [ ! -f "$BACKEND_FILE" ]; then
      #       echo "No backend configuration file found for environment ${{ env.ENVIRONMENT }}. Aborting."
      #       exit 1
      #     fi

      #     # terraform -chdir must be BEFORE the operation name. Ugly but required.
      #     # https://developer.hashicorp.com/terraform/cli/commands#switching-working-directory-with-chdir

      #     # Path to .tfbackend files is relative to AFTER the chdir in the terraform command

      #     terraform \
      #       -chdir=./terraform/configuration_layers/${{ matrix.configuration_layer }} \
      #       init \
      #       -backend-config="../../../$BACKEND_FILE"

      # - name: Prepare tfvars files
      #   env:
      #     TFVARS_GLOBAL_FILE: terraform/global.tfvars
      #     TFVARS_ENVIRONMENT_FILE: terraform/environments/${{ env.ENVIRONMENT }}.tfvars
      #     TFVARS_CONFIG_LAYER_FILE: terraform/configuration_layers/${{ matrix.configuration_layer }}/config/${{ env.ENVIRONMENT }}.tfvars
      #   run: |
      #     for f in "$TFVARS_GLOBAL_FILE" "$TFVARS_ENVIRONMENT_FILE" "$TFVARS_CONFIG_LAYER_FILE"; do
      #       if [ ! -f "$f" ]; then
      #         echo "No tfvars file found at $f. Aborting."
      #         exit 1
      #       fi
      #     done

      #     echo "TFVARS_GLOBAL_FILE=$TFVARS_GLOBAL_FILE" >> $GITHUB_ENV
      #     echo "TFVARS_ENVIRONMENT_FILE=$TFVARS_ENVIRONMENT_FILE" >> $GITHUB_ENV
      #     echo "TFVARS_CONFIG_LAYER_FILE=$TFVARS_CONFIG_LAYER_FILE" >> $GITHUB_ENV

      # - name: Terraform Plan
      #   run: |
      #     terraform \
      #       -chdir=./terraform/configuration_layers/${{ matrix.configuration_layer }} \
      #       plan \
      #       -var-file="../../../$TFVARS_GLOBAL_FILE" \
      #       -var-file="../../../$TFVARS_ENVIRONMENT_FILE" \
      #       -var-file="../../../$TFVARS_CONFIG_LAYER_FILE" \
      #       -out=${{ env.ENVIRONMENT }}-${{ matrix.configuration_layer }}.tfplan
